---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const tagSet = new Set<string>();

  for (const post of posts) {
    for (const tag of post.data.tags) {
      tagSet.add(tag.toLowerCase());
    }
  }

  return [...tagSet].map((tag) => ({
    params: { tag },
    props: {
      tag,
      posts: posts
        .filter((p) => p.data.tags.some((t: string) => t.toLowerCase() === tag))
        .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf()),
    },
  }));
}

const { tag, posts } = Astro.props;
---

<BaseLayout title={`Posts tagged "${tag}"`}>
  <h1 class="font-heading text-3xl font-bold mb-8">
    Posts tagged <span class="text-[var(--color-brand)]">"{tag}"</span>
  </h1>

  <ul class="space-y-8 list-none p-0">
    {posts.map((post: any) => {
      const slug = post.id.replace(/^\d{4}-\d{2}-\d{2}-/, '');
      const date = post.data.date;
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const href = `/${year}/${month}/${day}/${slug}`;
      const formattedDate = date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
      });

      return (
        <li>
          <a href={href} class="block group no-underline">
            <time class="text-sm text-[var(--color-text-light)]" datetime={date.toISOString()}>
              {formattedDate}
            </time>
            <h2 class="font-heading text-xl font-semibold mt-1 group-hover:text-[var(--color-brand)] transition-colors">
              {post.data.title}
            </h2>
            <p class="text-[var(--color-text-light)] mt-1">{post.data.description}</p>
          </a>
        </li>
      );
    })}
  </ul>

  <div class="mt-12">
    <a href="/tags" class="text-[var(--color-brand)] hover:underline">&larr; All tags</a>
  </div>
</BaseLayout>
